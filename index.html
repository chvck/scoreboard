<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

  <meta name="description" content="Personal blog site for chvck covering a range of topics but mostly bikes. chvck likes bikes." />
  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  
  <title>Scoreboard</title>
  <link href="reset.css" rel="stylesheet" type="text/css" media="screen" />
  <link href="style.css" rel="stylesheet" type="text/css" media="screen" />
  
  <script type="text/javascript" src="javascript/jquery-min-1.8.2.js"></script>
  <script type="text/javascript" src="javascript/inputmask/jquery.inputmask.js"></script>
  <script type="text/javascript" src="javascript/inputmask/jquery.inputmask.extensions.js"></script>

</head>

<body>
  <div class="container">
    <div id="top">
      <input type="text" value="15:00" id="timer" />
      <div id="controls">
        <span id="start">Start</span>
        <span>Reset</span>
      </div>
    </div>
    <div id="col1">
      <input type="text" value="Team1" class="teamName" />
      <input type="text" value="0" class="score" />
        <div class="scoreButtons">
          <input type="button" value="-" class="scoreButton" />
          <input type="button" value="+" class="scoreButton" />
        </div>
    </div>
    <div id="col2">
        <input type="text" value="Team2" class="teamName" />
        <input type="text" value="0" class="score" />
        <div class="scoreButtons">
          <input type="button" value="-" class="scoreButton" />
          <input type="button" value="+" class="scoreButton" />
        </div>
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
    $(document).ready(function() {
        var timer;
        var $timer = $('#timer');
        
        var format = function(value){
            while(value.length < 2) {
                value = '0' + value;
            }
            return value;
        }
            
        var onMaskInComplete = function() {
            var regex = /[_]/g;
            var splitTime = $timer.val().split(':');
            var minutes = splitTime[0].replace(regex, '');
            var seconds = splitTime[1].replace(regex, '');
                        
            $timer.val(format(String(minutes)) + ':' + format(String(seconds)));
        }
        
        $timer.inputmask({mask: '99:99', placeholder: '_', onincomplete: onMaskInComplete});

        $('input[type="text"]').each(function() {
            var $this = $(this);
            var len = $this.val().length;
            var width = $this.width() / len;
            var height = $this.height();
            $this.css('font-size', Math.min(width, height));
        });
        
        var updateTimer = function(time) {
            $('#timer').val(time);
        }
        
        $('#start').click(function() {
            timer = new Timer($('#timer').val());
            timer.subscribeToEmitter(updateTimer);
            timer.start();
        })

        var Timer = function(value) {
            var context = {};
            var ticks = 0;
            var counter;
            var emitHandlers = [];

            var convertToTicks = function(time) {
                var splitTime = time.split(':');
                var minutes = splitTime[0];
                var seconds = splitTime[1];
                
                ticks = Number(minutes * 60) + Number(seconds);
            }(value);
            
            var format = function(value){
                while(value.length < 2) {
                    value = '0' + value;
                }
                return value;
            }

            var convertFromTicks = function() {
                var minutes = Math.floor(ticks / 60);
                var seconds = ticks % 60;
                return format(String(minutes)) + ':' + format(String(seconds));
            }
            
            var timer = function() {
                ticks = ticks - 1;
                if (ticks === 0) {
                    clearInterval(counter);
                }
                context.emitTime(convertFromTicks());
            }

            context.start = function() {
                counter = setInterval(timer, 1000);
            }

            context.emitTime = function(time) {
                $.each(emitHandlers, function(idx, handler) { handler(time) });
            }
            
            context.subscribeToEmitter = function(fn) {
                emitHandlers.push(fn);
            }
            
            return context;
        }
    });
  </script>
  
</body>
</html>